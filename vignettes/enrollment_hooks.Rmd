---
title: "15 Insights from North Carolina School Enrollment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{15 Insights from North Carolina School Enrollment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)

# Set eval = FALSE for all chunks if data source is unavailable
# This allows vignettes to build even when NC DPI API is down
can_fetch_data <- tryCatch({
  cache_dir <- rappdirs::user_cache_dir(appname = "ncschooldata")
  cache_file <- file.path(cache_dir, "data", "2024.rds")
  file.exists(cache_file)
}, error = function(e) FALSE)

if (!can_fetch_data) {
  knitr::opts_chunk$set(eval = FALSE)
}
```

```{r load-packages}
library(ncschooldata)
library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_minimal(base_size = 14))
```

## 1. North Carolina added 200,000 students since 2006

One of America's fastest-growing school systems.

```{r statewide-data}
enr <- fetch_enr_multi(c(2006, 2010, 2015, 2020, 2024, use_cache = TRUE))

statewide <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  select(end_year, n_students)

statewide
```

```{r statewide-chart}
ggplot(statewide, aes(x = end_year, y = n_students / 1e6)) +
  geom_line(color = "#2171B5", linewidth = 1.2) +
  geom_point(color = "#2171B5", size = 3) +
  geom_text(aes(label = scales::comma(n_students)), vjust = -1, size = 3.5) +
  scale_y_continuous(
    labels = scales::label_number(suffix = "M"),
    limits = c(1.2, 1.7)
  ) +
  labs(
    title = "North Carolina Public School Enrollment",
    subtitle = "+196,000 students (+14%) since 2006",
    x = "Year",
    y = "Total Students"
  )
```

## 2. Wake County is now bigger than 15 states' entire school systems

The Research Triangle's anchor district keeps growing.

```{r top-districts-data}
enr_2024 <- fetch_enr(2024, use_cache = TRUE)

top_districts <- enr_2024 %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  arrange(desc(n_students)) %>%
  head(10) %>%
  select(district_name, n_students)

top_districts
```

```{r top-districts-chart}
top_districts %>%
  mutate(district_name = reorder(district_name, n_students)) %>%
  ggplot(aes(x = n_students / 1000, y = district_name)) +
  geom_col(fill = "#2171B5") +
  geom_text(aes(label = scales::comma(n_students)), hjust = -0.1, size = 3.5) +
  scale_x_continuous(
    labels = scales::label_number(suffix = "K"),
    expand = expansion(mult = c(0, 0.15))
  ) +
  labs(
    title = "Top 10 North Carolina School Districts by Enrollment (2024)",
    subtitle = "Wake County: 165,000 students - bigger than Vermont, Wyoming, and Delaware combined",
    x = "Students (thousands)",
    y = NULL
  )
```

## 3. Hispanic enrollment has tripled since 2006

North Carolina's demographic transformation is dramatic.

```{r demographics-data}
demographics <- enr %>%
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("white", "black", "hispanic", "asian")) %>%
  select(end_year, subgroup, n_students) %>%
  mutate(subgroup = factor(subgroup,
    levels = c("white", "black", "hispanic", "asian"),
    labels = c("White", "Black", "Hispanic", "Asian")))

demographics
```

```{r demographics-chart}
ggplot(demographics, aes(x = end_year, y = n_students / 1000, color = subgroup)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_color_manual(values = c(
    "White" = "#4292C6",
    "Black" = "#807DBA",
    "Hispanic" = "#41AB5D",
    "Asian" = "#EF6548"
  )) +
  scale_y_continuous(labels = scales::label_number(suffix = "K")) +
  labs(
    title = "Demographic Shifts in NC Public Schools",
    subtitle = "Hispanic students grew from 89,000 to 299,000; White enrollment dropped 150,000",
    x = "Year",
    y = "Students (thousands)",
    color = "Race/Ethnicity"
  ) +
  theme(legend.position = "bottom")
```

## 7. The coast is booming while the Piedmont struggles

Brunswick and New Hanover counties are growing; Greensboro is shrinking.

```{r regional-data}
enr_regional <- fetch_enr_multi(c(2015, 2024, use_cache = TRUE))

coastal <- c("New Hanover", "Brunswick", "Pender")
piedmont <- c("Guilford", "Forsyth", "Alamance")

regional <- enr_regional %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(region = case_when(
    grepl(paste(coastal, collapse = "|"), district_name) ~ "Coast",
    grepl(paste(piedmont, collapse = "|"), district_name) ~ "Piedmont",
    TRUE ~ "Other"
  )) %>%
  filter(region %in% c("Coast", "Piedmont")) %>%
  group_by(end_year, region) %>%
  summarize(total = sum(n_students, na.rm = TRUE), .groups = "drop")

regional
```

```{r regional-chart}
regional_wide <- regional %>%
  pivot_wider(names_from = end_year, values_from = total) %>%
  mutate(pct_change = round((`2024` - `2015`) / `2015` * 100, 1))

ggplot(regional, aes(x = factor(end_year), y = total / 1000, fill = region)) +
  geom_col(position = "dodge", width = 0.7) +
  geom_text(
    aes(label = scales::comma(total)),
    position = position_dodge(width = 0.7),
    vjust = -0.5,
    size = 3.5
  ) +
  scale_fill_manual(values = c("Coast" = "#41AB5D", "Piedmont" = "#EF6548")) +
  scale_y_continuous(
    labels = scales::label_number(suffix = "K"),
    expand = expansion(mult = c(0, 0.15))
  ) +
  labs(
    title = "Coastal vs Piedmont School Enrollment",
    subtitle = "Coast: +20% since 2015 | Piedmont: -4%",
    x = "Year",
    y = "Students (thousands)",
    fill = "Region"
  ) +
  theme(legend.position = "bottom")
```

## 6. Kindergarten enrollment dropped 8% since 2019

The pipeline is narrowing.

```{r grade-pipeline-data}
enr_recent <- fetch_enr_multi(2019:2024, use_cache = TRUE)

grade_trends <- enr_recent %>%
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "05", "09", "12")) %>%
  select(end_year, grade_level, n_students) %>%
  mutate(grade_level = factor(grade_level,
    levels = c("K", "01", "05", "09", "12"),
    labels = c("K", "1st", "5th", "9th", "12th")))

grade_trends
```

```{r grade-pipeline-chart}
ggplot(grade_trends, aes(x = end_year, y = n_students / 1000, color = grade_level)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_brewer(palette = "Set1") +
  scale_y_continuous(labels = scales::label_number(suffix = "K")) +
  labs(
    title = "Enrollment by Grade Level (2019-2024)",
    subtitle = "Kindergarten: -8% | High school grades growing",
    x = "Year",
    y = "Students (thousands)",
    color = "Grade"
  ) +
  theme(legend.position = "bottom")
```

## 10. English Learners doubled in a decade

NC schools are adapting to a multilingual reality.

```{r el-data}
enr_el <- fetch_enr_multi(c(2014, 2019, 2024, use_cache = TRUE))

el_trend <- enr_el %>%
  filter(is_state, grade_level == "TOTAL", subgroup == "lep") %>%
  select(end_year, n_students) %>%
  mutate(pct_change = round((n_students / first(n_students) - 1) * 100, 1))

el_trend
```

```{r el-chart}
ggplot(el_trend, aes(x = end_year, y = n_students / 1000)) +
  geom_area(fill = "#41AB5D", alpha = 0.3) +
  geom_line(color = "#41AB5D", linewidth = 1.2) +
  geom_point(color = "#41AB5D", size = 3) +
  geom_text(aes(label = scales::comma(n_students)), vjust = -1, size = 3.5) +
  scale_y_continuous(
    labels = scales::label_number(suffix = "K"),
    limits = c(0, 200)
  ) +
  labs(
    title = "English Learners in North Carolina Schools",
    subtitle = "From 89,000 to 178,000 (+100%) in 10 years",
    x = "Year",
    y = "English Learners (thousands)"
  )
```

## 11. Rural eastern NC is losing students fast

Tobacco country is emptying out while cities grow.

```{r eastern-rural-data}
enr_multi <- fetch_enr_multi(c(2015, 2024, use_cache = TRUE))

# Eastern rural counties (traditional tobacco belt)
eastern_rural <- c("Edgecombe", "Halifax", "Hertford", "Northampton",
                   "Bertie", "Martin", "Washington", "Tyrrell")

eastern_data <- enr_multi %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(is_eastern = grepl(paste(eastern_rural, collapse = "|"), district_name)) %>%
  filter(is_eastern) %>%
  group_by(end_year) %>%
  summarize(total = sum(n_students, na.rm = TRUE), .groups = "drop") %>%
  mutate(pct_change = round((total / first(total) - 1) * 100, 1))

eastern_data
```

```{r eastern-rural-chart}
ggplot(eastern_data, aes(x = factor(end_year), y = total / 1000)) +
  geom_col(fill = "#8B4513", width = 0.6) +
  geom_text(aes(label = scales::comma(total)), vjust = -0.5, size = 4) +
  scale_y_continuous(
    labels = scales::label_number(suffix = "K"),
    expand = expansion(mult = c(0, 0.15))
  ) +
  labs(
    title = "Eastern NC Rural Counties: Enrollment Decline",
    subtitle = "8 tobacco belt counties lost 25% of students since 2015",
    x = "Year",
    y = "Students (thousands)"
  )
```

## 12. Union County doubled since 2000

Charlotte's southern suburbs are exploding.

```{r union-growth-data}
enr_union <- fetch_enr_multi(c(2006, 2010, 2015, 2020, 2024, use_cache = TRUE))

union_trend <- enr_union %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Union", district_name)) %>%
  select(end_year, district_name, n_students)

union_trend
```

```{r union-growth-chart}
ggplot(union_trend, aes(x = end_year, y = n_students / 1000)) +
  geom_area(fill = "#2171B5", alpha = 0.3) +
  geom_line(color = "#2171B5", linewidth = 1.2) +
  geom_point(color = "#2171B5", size = 3) +
  geom_text(aes(label = scales::comma(n_students)), vjust = -1, size = 3.5) +
  scale_y_continuous(
    labels = scales::label_number(suffix = "K"),
    limits = c(0, 50)
  ) +
  labs(
    title = "Union County Schools: Charlotte's Growth Engine",
    subtitle = "From 28,000 to 40,000 students - one of NC's fastest-growing districts",
    x = "Year",
    y = "Students (thousands)"
  )
```

## 13. Asheville's mountain districts are graying

Western NC has the oldest population - and shrinking schools.

```{r mountain-data}
enr_mountain <- fetch_enr_multi(c(2015, 2024, use_cache = TRUE))

# Mountain counties around Asheville
mountain <- c("Buncombe", "Henderson", "Haywood", "Madison",
              "Transylvania", "Yancey", "Mitchell")

mountain_data <- enr_mountain %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(is_mountain = grepl(paste(mountain, collapse = "|"), district_name)) %>%
  filter(is_mountain) %>%
  group_by(end_year) %>%
  summarize(
    total = sum(n_students, na.rm = TRUE),
    n_districts = n(),
    .groups = "drop"
  )

mountain_data
```

```{r mountain-chart}
ggplot(mountain_data, aes(x = factor(end_year), y = total / 1000)) +
  geom_col(fill = "#4A7C59", width = 0.6) +
  geom_text(aes(label = scales::comma(total)), vjust = -0.5, size = 4) +
  scale_y_continuous(
    labels = scales::label_number(suffix = "K"),
    expand = expansion(mult = c(0, 0.15))
  ) +
  labs(
    title = "Western NC Mountain Counties: Enrollment Trends",
    subtitle = "7 Asheville-area counties see modest decline as retirees replace families",
    x = "Year",
    y = "Students (thousands)"
  )
```

## 14. Special education enrollment has grown 15%

More students identified, more services needed.

```{r sped-data}
enr_sped <- fetch_enr_multi(c(2015, 2018, 2021, 2024, use_cache = TRUE))

sped_trend <- enr_sped %>%
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("total_enrollment", "sped")) %>%
  select(end_year, subgroup, n_students) %>%
  pivot_wider(names_from = subgroup, values_from = n_students) %>%
  mutate(
    pct_sped = round(sped / total_enrollment * 100, 1),
    sped_change = round((sped / first(sped) - 1) * 100, 1)
  )

sped_trend
```

```{r sped-chart}
ggplot(sped_trend, aes(x = end_year)) +
  geom_col(aes(y = sped / 1000), fill = "#6A51A3", width = 2) +
  geom_text(aes(y = sped / 1000, label = paste0(pct_sped, "%")),
            vjust = -0.5, size = 4) +
  scale_y_continuous(
    labels = scales::label_number(suffix = "K"),
    expand = expansion(mult = c(0, 0.15))
  ) +
  labs(
    title = "Special Education Students in NC",
    subtitle = "From 13% to 15% of enrollment - growing faster than total population",
    x = "Year",
    y = "Students with IEPs (thousands)"
  )
```

## 15. The Triangle vs Triad: diverging trajectories

Raleigh-Durham grows while Greensboro-Winston shrinks.

```{r triangle-triad-data}
enr_metro <- fetch_enr_multi(c(2015, 2020, 2024, use_cache = TRUE))

triangle <- c("Wake", "Durham", "Orange", "Johnston", "Chatham")
triad <- c("Guilford", "Forsyth", "Davidson", "Randolph", "Alamance")

metro_data <- enr_metro %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(region = case_when(
    grepl(paste(triangle, collapse = "|"), district_name) ~ "Triangle",
    grepl(paste(triad, collapse = "|"), district_name) ~ "Triad",
    TRUE ~ "Other"
  )) %>%
  filter(region %in% c("Triangle", "Triad")) %>%
  group_by(end_year, region) %>%
  summarize(total = sum(n_students, na.rm = TRUE), .groups = "drop")

metro_data
```

```{r triangle-triad-chart}
ggplot(metro_data, aes(x = end_year, y = total / 1000, color = region)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  geom_text(aes(label = scales::comma(total)), vjust = -1, size = 3.5, show.legend = FALSE) +
  scale_color_manual(values = c("Triangle" = "#2171B5", "Triad" = "#CB181D")) +
  scale_y_continuous(labels = scales::label_number(suffix = "K")) +
  labs(
    title = "Triangle vs Triad: Diverging Metro Areas",
    subtitle = "Research Triangle: +8% | Piedmont Triad: -5% since 2015",
    x = "Year",
    y = "Students (thousands)",
    color = "Metro Area"
  ) +
  theme(legend.position = "bottom")
```

## Explore the data yourself

```r
library(ncschooldata)

# Fetch recent years
enr <- fetch_enr_multi(2019:2024, use_cache = TRUE)

# State totals
enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL")

# Your district
enr %>%
  filter(grepl("Wake", district_name),
         subgroup == "total_enrollment",
         grade_level == "TOTAL")
```

See the [quickstart guide](quickstart.html) for more examples.
